<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>دردشة مترجمة متكاملة</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#071025; --card:#0f1724; --accent:#00d1b2; --accent2:#3b82f6; --muted:#9aa6bf;
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma,Arial;background:linear-gradient(135deg,var(--bg),#051029);color:#fff;direction:rtl}
    header{padding:12px;display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.02)}
    .nav {display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .nav button{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000;cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:12px}
    .page{display:none;background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    .page.active{display:block}
    h2{margin:0 0 8px 0;color:var(--accent)}
    label{display:block;margin-top:8px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:#fff}
    button.gray{background:#333;color:#fff}
    .users-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .user-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .meta{flex:1}
    #chat-box{height:56vh;overflow:auto;padding:12px;background:rgba(0,0,0,0.06);border-radius:8px}
    .msg{margin:8px 0;padding:10px;border-radius:12px;max-width:76%;word-break:break-word}
    .me{background:linear-gradient(90deg,var(--accent),#00f6d0);color:#000;margin-left:auto;text-align:right}
    .other{background:#1b2638;color:#fff;margin-right:auto;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    .small{padding:8px;font-size:13px}
    .incoming-call{position:fixed;left:22px;bottom:22px;background:#111;padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none;z-index:999}
    .hidden{display:none}
    img,video,audio{max-width:320px;border-radius:8px;margin-top:6px}
    .badge{background:var(--danger);color:#fff;padding:2px 6px;border-radius:10px;margin-left:6px;font-size:12px}
    footer.note{max-width:1100px;margin:12px auto;color:var(--muted);font-size:13px;text-align:center}
    @media(max-width:900px){body{padding:8px} header{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
<header>
  <div>
    <strong>دردشة مترجمة متكاملة</strong><br>
    <span class="muted">تشغيل محلي: استخدم Chrome/Edge لتجربة الصوت والـWebRTC</span>
  </div>
  <div class="nav">
    <button id="navLogin">🔐 تسجيل</button>
    <button id="navSearch">🔍 بحث</button>
    <button id="navRequests">📨 إشعارات <span id="reqBadge" class="badge hidden">0</span></button>
    <button id="navFriends">👥 أصدقائي</button>
    <button id="navChat">💬 دردشة</button>
    <button id="navLogout" class="gray hidden">خروج</button>
  </div>
</header>

<main>
  <!-- LOGIN PAGE -->
  <section id="pageLogin" class="page active">
    <h2>🔐 تسجيل / اختيار اللغة</h2>
    <label>اسم المستخدم</label>
    <input id="username" placeholder="اكتب اسمك...">
    <label>ابحث لغة (اكتب للبحث)</label>
    <input id="langSearch" placeholder="ابحث باسم اللغة...">
    <label>اختر لغة التحدث (تـُحفظ عند التسجيل)</label>
    <select id="langSelect" size="6" style="height:160px"></select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="loginBtn">دخول</button>
      <button id="guestBtn" class="gray">دخول كزائر</button>
    </div>
  </section>

  <!-- SEARCH PAGE -->
  <section id="pageSearch" class="page">
    <h2>🔍 بحث عن مستخدم</h2>
    <div class="muted">ابحث باسم المستخدم ثم أرسل طلب صداقة</div>
    <input id="userSearch" placeholder="ابحث باسم المستخدم...">
    <div id="userResults" class="users-list"></div>
  </section>

  <!-- REQUESTS PAGE -->
  <section id="pageRequests" class="page">
    <h2>📨 طلبات واردة</h2>
    <div id="requestsList"></div>
  </section>

  <!-- FRIENDS PAGE -->
  <section id="pageFriends" class="page">
    <h2>👥 أصدقائي</h2>
    <div id="friendsList" class="users-list"></div>
  </section>

  <!-- CHAT PAGE -->
  <section id="pageChat" class="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 id="chatTitle">💬 لا يوجد محادثة</h2>
        <div id="chatSubtitle" class="muted">اختر صديقاً من صفحة "أصدقائي" لبدء</div>
      </div>
      <div style="width:260px">
        <label>تبديل لغتي داخل الدردشة</label>
        <select id="chatLangSelect" size="4" style="height:90px"></select>
      </div>
    </div>

    <div id="chat-box"></div>

    <div class="controls">
      <input id="msgInput" placeholder="اكتب رسالتك..." />
      <button id="sendBtn" class="small">إرسال</button>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input type="file" id="fileInput" accept="image/*,video/*">
      <button id="sendFileBtn" class="small">إرسال ملف</button>
      <button id="recordVoiceBtn" class="small">🎤 تسجيل صوتي (إرسال)</button>
      <button id="playVoiceBtn" class="small hidden">▶️ تشغيل صوتي</button>
      <div style="flex:1"></div>
      <div class="muted">لغتي الحالية: <span id="currentLangLabel">—</span></div>
    </div>

    <hr style="opacity:0.06;margin:12px 0">
    <h2>📞 مكالمات صوتية مترجمة</h2>
    <div class="muted">اضغط "مكالمة" من صفحة الأصدقاء لبدء مكالمة صوتية فورية.</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="endCallBtn" class="gray small hidden">إنهاء المكالمة</button>
    </div>
  </section>
</main>

<!-- Incoming call modal -->
<div id="incomingCall" class="incoming-call">
  <div id="callerTxt" style="margin-bottom:8px">📞 اتصال وارد</div>
  <div style="display:flex;gap:8px">
    <button id="answerBtn">📥 رد</button>
    <button id="rejectBtn" class="gray">❌ رفض</button>
  </div>
</div>

<footer class="note">مثال تعليمي — عدّل قواعد Firebase قبل النشر. استخدم Chrome/Edge لتجرب الميزات الصوتية.</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
/* ============================================================
   ملف واحد شامل: صفحات داخلية + Firebase + WebRTC + Speech
   ============================================================ */

/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCNXyQF2ZCMaxuBplGivMZiz_rFnCt6e0M",
  authDomain: "grasias-260c5.firebaseapp.com",
  projectId: "grasias-260c5",
  storageBucket: "grasias-260c5.appspot.com",
  messagingSenderId: "673016515237",
  appId: "1:673016515237:web:ecd56c7e6b0dc81af51b4c",
  databaseURL: "https://grasias-260c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ================= LANGS ================= */
const langs = [
  {code:"ar",name:"العربية"},{code:"en",name:"English"},{code:"es",name:"Español"},{code:"fr",name:"Français"},
  {code:"de",name:"Deutsch"},{code:"pt",name:"Português"},{code:"ru",name:"Русский"},{code:"zh",name:"中文"},
  {code:"hi",name:"हिन्दी"},{code:"tr",name:"Türkçe"},{code:"it",name:"Italiano"},{code:"ja",name:"日本語"}
];
function getLangName(c){ const f = langs.find(x=>x.code===c); return f?f.name:c; }

/* ================= STATE ================= */
let currentUser = null;
let userLang = "ar";
let currentPeer = null;
let currentChatId = null;

let pc = null;                 // RTCPeerConnection
let localStream = null;
let recognition = null;
let isInCall = false;
let incomingCallId = null;
let incomingCaller = null;

/* ================= DOM ================= */
const pages = {
  login: document.getElementById("pageLogin"),
  search: document.getElementById("pageSearch"),
  requests: document.getElementById("pageRequests"),
  friends: document.getElementById("pageFriends"),
  chat: document.getElementById("pageChat")
};
const navLogin = document.getElementById("navLogin");
const navSearch = document.getElementById("navSearch");
const navRequests = document.getElementById("navRequests");
const navFriends = document.getElementById("navFriends");
const navChat = document.getElementById("navChat");
const navLogout = document.getElementById("navLogout");
const reqBadge = document.getElementById("reqBadge");

const usernameEl = document.getElementById("username");
const langSearchEl = document.getElementById("langSearch");
const langSelectEl = document.getElementById("langSelect");
const loginBtn = document.getElementById("loginBtn");
const guestBtn = document.getElementById("guestBtn");

const userSearchEl = document.getElementById("userSearch");
const userResultsEl = document.getElementById("userResults");
const requestsListEl = document.getElementById("requestsList");
const friendsListEl = document.getElementById("friendsList");

const chatBoxEl = document.getElementById("chat-box");
const chatTitleEl = document.getElementById("chatTitle");
const chatSubtitleEl = document.getElementById("chatSubtitle");
const msgInputEl = document.getElementById("msgInput");
const sendBtnEl = document.getElementById("sendBtn");
const fileInputEl = document.getElementById("fileInput");
const sendFileBtnEl = document.getElementById("sendFileBtn");
const recordVoiceBtn = document.getElementById("recordVoiceBtn");
const playVoiceBtn = document.getElementById("playVoiceBtn");
const chatLangSelect = document.getElementById("chatLangSelect");
const currentLangLabel = document.getElementById("currentLangLabel");
const endCallBtn = document.getElementById("endCallBtn");

const incomingCallEl = document.getElementById("incomingCall");
const callerTxtEl = document.getElementById("callerTxt");
const answerBtn = document.getElementById("answerBtn");
const rejectBtn = document.getElementById("rejectBtn");

/* ================= UI Navigation ================= */
function showPage(name){
  Object.values(pages).forEach(p => p.classList.remove("active"));
  pages[name].classList.add("active");
}
navLogin.addEventListener("click", ()=> showPage("login"));
navSearch.addEventListener("click", ()=> showPage("search"));
navRequests.addEventListener("click", ()=> showPage("requests"));
navFriends.addEventListener("click", ()=> showPage("friends"));
navChat.addEventListener("click", ()=> showPage("chat"));

/* ================= Render languages ================= */
function renderLangs(filter=""){
  langSelectEl.innerHTML = "";
  langs.filter(l => l.name.toLowerCase().includes(filter.toLowerCase()))
    .forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.code; opt.textContent = l.name;
      langSelectEl.appendChild(opt);
    });
  chatLangSelect.innerHTML = "";
  langs.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l.code; opt.textContent = l.name;
    chatLangSelect.appendChild(opt);
  });
  if(!langSelectEl.value) langSelectEl.value = "ar";
  chatLangSelect.value = userLang;
  currentLangLabel.innerText = getLangName(userLang);
}
langSearchEl.addEventListener("input", e => renderLangs(e.target.value));
chatLangSelect.addEventListener("change", async (e) => {
  userLang = e.target.value;
  localStorage.setItem("chat_lang", userLang);
  if(currentUser) await db.ref("users/" + currentUser).update({ lang: userLang });
  currentLangLabel.innerText = getLangName(userLang);
});
renderLangs();

/* ================= Auth: login / guest / restore / logout ================= */
loginBtn.addEventListener("click", async () => {
  const name = usernameEl.value.trim();
  if(!name) return alert("أدخل اسم المستخدم");
  currentUser = name;
  userLang = langSelectEl.value || "ar";
  await db.ref("users/" + currentUser).set({ lang: userLang, online: true, lastSeen: Date.now() });
  localStorage.setItem("chat_user", currentUser);
  localStorage.setItem("chat_lang", userLang);
  usernameEl.disabled = true;
  navLogout.classList.remove("hidden");
  showPage("friends");
  loadRequests(); loadFriends(); watchIncomingCalls(); setupTranscriptsListenerForUser(); updateReqBadge();
});

guestBtn.addEventListener("click", async () => {
  const name = "Guest_" + Math.floor(Math.random()*9000+1000);
  usernameEl.value = name;
  await loginBtn.click();
});

navLogout.addEventListener("click", async () => {
  if(!currentUser) return;
  await db.ref("users/" + currentUser).update({ online: false, lastSeen: Date.now() });
  localStorage.removeItem("chat_user"); localStorage.removeItem("chat_lang");
  currentUser = null; userLang = "ar";
  usernameEl.disabled = false; usernameEl.value = "";
  navLogout.classList.add("hidden");
  userResultsEl.innerHTML = ""; requestsListEl.innerHTML = ""; friendsListEl.innerHTML = ""; chatBoxEl.innerHTML = "";
  showPage("login");
});

/* restore */
window.addEventListener("load", async () => {
  const saved = localStorage.getItem("chat_user");
  const savedLang = localStorage.getItem("chat_lang");
  if(saved){
    currentUser = saved;
    userLang = savedLang || "ar";
    usernameEl.value = currentUser; usernameEl.disabled = true; navLogout.classList.remove("hidden");
    await db.ref("users/" + currentUser).set({ lang: userLang, online: true, lastSeen: Date.now() });
    loadRequests(); loadFriends(); watchIncomingCalls(); setupTranscriptsListenerForUser(); updateReqBadge();
  }
});
window.addEventListener("beforeunload", async () => {
  if(currentUser){
    try{ await db.ref("users/" + currentUser).update({ online: false, lastSeen: Date.now() }); } catch(e){}
  }
});

/* ================= Search users ================= */
userSearchEl.addEventListener("input", async (e) => {
  const q = e.target.value.trim().toLowerCase();
  userResultsEl.innerHTML = "";
  if(!q) return;
  const snap = await db.ref("users").once("value");
  const users = snap.val() || {};
  for(const name in users){
    if(name.toLowerCase().includes(q) && name !== currentUser){
      const row = document.createElement("div"); row.className="user-row";
      const meta = document.createElement("div"); meta.className="meta";
      meta.innerHTML = `<strong>${name}</strong><div class="muted">اللغة: ${getLangName(users[name].lang)}</div>`;
      const actions = document.createElement("div"); actions.style.display="flex"; actions.style.gap="6px";
      const sendBtn = document.createElement("button"); sendBtn.className="small"; sendBtn.textContent="إرسال طلب";
      sendBtn.onclick = () => sendFriendRequest(name);
      const viewBtn = document.createElement("button"); viewBtn.className="small gray"; viewBtn.textContent="عرض";
      viewBtn.onclick = () => alert("عرض ملف: " + name + "\n(ميزة توسّع لاحقاً)");
      actions.appendChild(sendBtn); actions.appendChild(viewBtn);
      row.appendChild(meta); row.appendChild(actions);
      userResultsEl.appendChild(row);
    }
  }
});

/* ================= Friend requests ================= */
async function sendFriendRequest(toUser){
  if(!currentUser) return alert("سجّل أولاً");
  if(toUser === currentUser) return;
  await db.ref("friendRequests/" + toUser + "/" + currentUser).set({ from: currentUser, ts: Date.now() });
  alert("تم إرسال طلب صداقة إلى " + toUser);
}

function loadRequests(){
  if(!currentUser) return;
  db.ref("friendRequests/" + currentUser).on("value", snap => {
    const data = snap.val() || {};
    requestsListEl.innerHTML = "";
    const keys = Object.keys(data);
    if(keys.length === 0){
      requestsListEl.innerHTML = "<div class='muted'>لا توجد طلبات واردة</div>";
      return;
    }
    for(const fromUser in data){
      const row = document.createElement("div"); row.className="user-row";
      row.innerHTML = `<div class="meta"><strong>${fromUser}</strong><div class="muted">طلب صداقة وارد</div></div>`;
      const acceptBtn = document.createElement("button"); acceptBtn.className="small"; acceptBtn.textContent="قبول";
      acceptBtn.onclick = () => acceptRequest(fromUser);
      const rejectBtn = document.createElement("button"); rejectBtn.className="small gray"; rejectBtn.textContent="رفض";
      rejectBtn.onclick = () => rejectRequest(fromUser);
      row.appendChild(acceptBtn); row.appendChild(rejectBtn);
      requestsListEl.appendChild(row);
    }
    updateReqBadge();
  });
}

async function acceptRequest(fromUser){
  if(!currentUser) return;
  await db.ref("friends/" + currentUser + "/" + fromUser).set(true);
  await db.ref("friends/" + fromUser + "/" + currentUser).set(true);
  await db.ref("friendRequests/" + currentUser + "/" + fromUser).remove();
  alert("تم قبول " + fromUser);
}

async function rejectRequest(fromUser){
  if(!currentUser) return;
  await db.ref("friendRequests/" + currentUser + "/" + fromUser).remove();
  alert("تم رفض " + fromUser);
}

function updateReqBadge(){
  if(!currentUser) { reqBadge.classList.add("hidden"); return; }
  db.ref("friendRequests/" + currentUser).once("value").then(snap=>{
    const n = snap.val() ? Object.keys(snap.val()).length : 0;
    if(n>0){ reqBadge.textContent = n; reqBadge.classList.remove("hidden"); } else { reqBadge.classList.add("hidden"); }
  });
}

/* ================= Friends list ================= */
function loadFriends(){
  if(!currentUser) return;
  db.ref("friends/" + currentUser).on("value", snap => {
    const data = snap.val() || {};
    friendsListEl.innerHTML = "";
    const keys = Object.keys(data);
    if(keys.length===0){
      friendsListEl.innerHTML = "<div class='muted'>لم تقبل أصدقاء بعد.</div>";
      return;
    }
    for(const friend in data){
      const row = document.createElement("div"); row.className="user-row";
      const meta = document.createElement("div"); meta.className="meta"; meta.innerHTML = `<strong>${friend}</strong>`;
      const chatBtn = document.createElement("button"); chatBtn.className="small"; chatBtn.textContent="دردشة";
      chatBtn.onclick = ()=> openChat(friend);
      const callBtn = document.createElement("button"); callBtn.className="small gray"; callBtn.textContent="📞 مكالمة";
      callBtn.onclick = ()=> initiateCall(friend);
      const removeBtn = document.createElement("button"); removeBtn.className="small gray"; removeBtn.textContent="حذف";
      removeBtn.onclick = ()=> removeFriend(friend);
      row.appendChild(meta); row.appendChild(chatBtn); row.appendChild(callBtn); row.appendChild(removeBtn);
      friendsListEl.appendChild(row);
    }
  });
}

async function removeFriend(name){
  if(!currentUser) return;
  if(!confirm("هل تريد حذف " + name + "؟")) return;
  await db.ref("friends/" + currentUser + "/" + name).remove();
  await db.ref("friends/" + name + "/" + currentUser).remove();
  alert("تم الحذف");
}

/* ================= Chat: open/send/render (with auto-translate) ================= */
function getChatId(a,b){ return [a,b].sort().join("_"); }

function openChat(peer){
  currentPeer = peer;
  currentChatId = getChatId(currentUser, peer);
  chatTitleEl.textContent = "💬 دردشة مع: " + peer;
  chatSubtitleEl.textContent = "اللغة الحالية: " + getLangName(userLang);
  chatBoxEl.innerHTML = "";
  showPage("chat");

  // listen for messages
  db.ref("chats/" + currentChatId + "/messages").off();
  db.ref("chats/" + currentChatId + "/messages").on("child_added", async snap => {
    const data = snap.val();
    await renderMessageWithTranslation(data);
  });
}

/* render message: translate automatically to user's language and show audio and text */
async function renderMessageWithTranslation(data){
  const el = document.createElement("div");
  el.className = "msg " + (data.sender === currentUser ? "me" : "other");
  // message types: text, media (image/video), audio (voice clip)
  if(data.type === "media"){
    if(data.mediaType && data.mediaType.startsWith("image")){
      el.innerHTML = `<b>${escapeHtml(data.sender)}:</b><br><img src="${data.text}" alt="image">`;
    } else {
      el.innerHTML = `<b>${escapeHtml(data.sender)}:</b><br><video src="${data.text}" controls></video>`;
    }
  } else if(data.type === "voice"){
    // show audio player and show transcript + translated transcript
    el.innerHTML = `<b>${escapeHtml(data.sender)}:</b><br><audio src="${data.audioUrl}" controls></audio>`;
    // if transcript exists
    if(data.transcript){
      const tdiv = document.createElement("div"); tdiv.className="muted";
      tdiv.textContent = `${data.sender} (النص): ${data.transcript}`;
      el.appendChild(tdiv);
      // translate transcript to my language
      const translated = await translateText(data.transcript, userLang);
      const tr = document.createElement("div"); tr.className="muted";
      tr.innerHTML = `→ ترجمة (${data.lang || 'auto'} → ${userLang}): ${escapeHtml(translated)} <button class="small" onclick="speakText('${escapeJs(translated)}','${userLang}')">🔊</button>`;
      el.appendChild(tr);
    } else {
      // if no transcript, attempt to convert audio -> not trivial in browser; we rely on sender's SpeechRecognition (we do that in recording)
      const note = document.createElement("div"); note.className="muted";
      note.textContent = "لا يوجد تفريغ صوتي (transcript).";
      el.appendChild(note);
    }
  } else { // plain text
    // translate text to user's language
    const translated = await translateText(data.text, userLang);
    el.innerHTML = `<b>${escapeHtml(data.sender)}:</b> ${escapeHtml(translated)}`;
    // also show original if different language (optional)
    if(data.lang && data.lang !== userLang){
      const orig = document.createElement("div"); orig.className="muted";
      orig.textContent = `(${data.lang}) الأصلي: ${escapeHtml(data.text)}`;
      el.appendChild(orig);
    }
  }
  chatBoxEl.appendChild(el);
  chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
}

/* send text message (store its original text + lang) */
sendBtnEl.addEventListener("click", async () => {
  if(!currentPeer) return alert("اختر صديقاً أولاً من صفحة الأصدقاء");
  const text = msgInputEl.value.trim();
  if(!text) return;
  const id = currentChatId || getChatId(currentUser, currentPeer);
  await db.ref("chats/" + id + "/messages").push({
    sender: currentUser, text, lang: userLang || 'auto', type: "text", timestamp: Date.now()
  });
  msgInputEl.value = "";
});

/* send media file */
sendFileBtn.addEventListener("click", async () => {
  if(!currentPeer) return alert("اختر صديقاً أولاً");
  const f = fileInput.files[0];
  if(!f) return alert("اختر ملفاً");
  const path = "chatFiles/" + Date.now() + "_" + sanitizeFilename(f.name);
  const storageRef = storage.ref(path);
  const uploadTask = storageRef.put(f);
  uploadTask.on('state_changed', null, err => alert("خطأ بالرفع: " + err.message), async () => {
    const url = await storageRef.getDownloadURL();
    const id = currentChatId || getChatId(currentUser, currentPeer);
    await db.ref("chats/" + id + "/messages").push({
      sender: currentUser, text: url, lang: userLang, type: "media", mediaType: f.type, timestamp: Date.now()
    });
    fileInput.value = "";
  });
});

/* ================= Voice recording: record audio + SpeechRecognition to get transcript, then upload audio + push message (type=voice) ================= */
recordVoiceBtn.addEventListener("click", async () => {
  if(!currentPeer) return alert("اختر صديقاً أولاً");
  // check APIs
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!navigator.mediaDevices || !SpeechRecognition){
    return alert("المتصفح لا يدعم التسجيل أو SpeechRecognition. استخدم Chrome/Edge.");
  }

  // get mic stream
  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch(err) {
    return alert("فشل بالحصول على المايك: " + err.message);
  }

  // set up recorder
  const recorder = new MediaRecorder(stream);
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);

  // set up speech recognition
  const rec = new SpeechRecognition();
  rec.lang = userLang || 'ar';
  rec.interimResults = false;
  rec.continuous = false;

  let finalTranscript = "";

  rec.onresult = (ev) => {
    const last = ev.results[ev.resultIndex];
    finalTranscript += last[0].transcript.trim();
  };
  rec.onerror = (e) => console.warn("recognition error", e);
  rec.onend = () => {
    // recognition ended
  };

  // start both
  try {
    rec.start();
  } catch(e){}
  recorder.start();

  // record for 4 seconds (adjustable)
  recordVoiceBtn.textContent = "⏹️ تسجيل..."; recordVoiceBtn.disabled = true;
  setTimeout(async () => {
    recorder.stop();
    try{ rec.stop(); } catch(e){}
    recordVoiceBtn.textContent = "🎤 تسجيل صوتي (إرسال)"; recordVoiceBtn.disabled = false;
    stream.getTracks().forEach(t=>t.stop());
  }, 4000);

  recorder.onstop = async () => {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const filename = "voices/" + Date.now() + "_" + currentUser + ".webm";
    const ref = storage.ref(filename);
    await ref.put(blob);
    const url = await ref.getDownloadURL();

    // push message with audio URL and transcript (if any)
    const id = currentChatId || getChatId(currentUser, currentPeer);
    await db.ref("chats/" + id + "/messages").push({
      sender: currentUser,
      type: "voice",
      audioUrl: url,
      transcript: finalTranscript || "",
      lang: userLang || 'auto',
      timestamp: Date.now()
    });

    // if transcript absent, nothing we can do (server-side STT required)
  };
});

/* ================= Translate helper (gtx) ================= */
async function translateText(text, target){
  if(!text) return "";
  try{
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${encodeURIComponent(target)}&dt=t&q=${encodeURIComponent(text)}`;
    const res = await fetch(url);
    const data = await res.json();
    return (data && data[0] && data[0][0] && data[0][0][0]) ? data[0][0][0] : text;
  } catch(err){
    console.error("translate error", err);
    return text;
  }
}

/* ================= Speech Synthesis (speak) ================= */
function speakText(text, lang){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    window.speechSynthesis.speak(u);
  } catch(e){ console.error("speak error", e); }
}

/* ================= WebRTC Calling (signaling via Firebase) ================= */
/* This is basic: create offer/answer + ICE via DB. For production add TURN server. */

async function initiateCall(peerName){
  if(!currentUser) return alert("سجّل أولاً");
  if(!peerName) return;
  currentPeer = peerName;
  const chatId = getChatId(currentUser, peerName);
  currentChatId = chatId;

  await db.ref("calls/" + chatId + "/meta").set({
    from: currentUser, to: peerName, callerLang: userLang, timestamp: Date.now()
  });

  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

  try { localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false }); }
  catch(err){ return alert("فشل بالحصول على الميكروفون: " + err.message); }
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  const candRef = db.ref("calls/" + chatId + "/candidates");
  pc.onicecandidate = e => { if(e.candidate) candRef.push(JSON.stringify(e.candidate)); };

  pc.ontrack = ev => {
    const audio = document.createElement("audio"); audio.autoplay = true; audio.srcObject = ev.streams[0]; audio.style.display="none";
    document.body.appendChild(audio);
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await db.ref("calls/" + chatId + "/offer").set(JSON.stringify(offer));

  db.ref("calls/" + chatId + "/answer").on("value", async snap => {
    const val = snap.val();
    if(val && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(val));
      startSpeechRecognitionAndTranslate(chatId, userLang);
      isInCall = true;
      endCallBtn.classList.remove("hidden");
      chatTitleEl.textContent = `📞 في مكالمة مع ${peerName}`;
    }
  });

  db.ref("calls/" + chatId + "/candidates").on("child_added", async snap => {
    const v = snap.val();
    if(v && pc) {
      try { await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(v))); } catch(e){}
    }
  });

  // show transcripts pushed to call
  db.ref("calls/" + chatId + "/transcripts").on("child_added", snap => {
    const d = snap.val();
    if(!d) return;
    const el = document.createElement("div"); el.className="msg me";
    el.innerHTML = `<b>🔁 ترجمة (${d.source}→${d.target}):</b> ${escapeHtml(d.translated)}`;
    chatBoxEl.appendChild(el); chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
  });
}

/* watch incoming calls */
function watchIncomingCalls(){
  db.ref("calls").on("child_added", async snap => {
    const chatId = snap.key;
    const val = snap.val();
    if(!val || !val.meta) return;
    const meta = val.meta;
    if(meta.to === currentUser && !isInCall){
      incomingCallId = chatId; incomingCaller = meta.from;
      callerTxtEl.textContent = `📞 اتصال وارد من: ${incomingCaller}`;
      incomingCallEl.style.display = "block";
    }
  });
}

/* answer incoming call */
answerBtn.addEventListener("click", async () => {
  if(!incomingCallId) return;
  incomingCallEl.style.display = "none";
  const metaSnap = await db.ref("calls/" + incomingCallId + "/meta").once("value");
  const meta = metaSnap.val(); if(!meta) return alert("لا توجد بيانات للمكالمة");
  currentPeer = meta.from; currentChatId = incomingCallId;

  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  try{ localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:false}); }
  catch(err){ return alert("فشل بالحصول على المايك: " + err.message); }
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = ev => {
    const audio = document.createElement("audio"); audio.autoplay = true; audio.srcObject = ev.streams[0]; audio.style.display="none";
    document.body.appendChild(audio);
  };

  const candRef = db.ref("calls/" + incomingCallId + "/candidates");
  pc.onicecandidate = e => { if(e.candidate) candRef.push(JSON.stringify(e.candidate)); };

  const offerSnap = await db.ref("calls/" + incomingCallId + "/offer").once("value");
  const offer = offerSnap.val(); if(!offer) return alert("لا يوجد عرض");
  await pc.setRemoteDescription(JSON.parse(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await db.ref("calls/" + incomingCallId + "/answer").set(JSON.stringify(answer));

  db.ref("calls/" + incomingCallId + "/candidates").on("child_added", async snap => {
    const v = snap.val(); if(v && pc) { try{ await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(v))); } catch(e){} }
  });

  // listen transcripts and speak when targeted
  db.ref("calls/" + incomingCallId + "/transcripts").on("child_added", async snap => {
    const d = snap.val(); if(!d) return;
    if(d.to === currentUser){
      speakText(d.translated, d.target);
      const el = document.createElement("div"); el.className="msg other";
      el.innerHTML = `<b>🔁 (${d.from}→${d.target}):</b> ${escapeHtml(d.translated)}`;
      chatBoxEl.appendChild(el); chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
    }
  });

  isInCall = true; endCallBtn.classList.remove("hidden"); chatTitleEl.textContent = `📞 في مكالمة مع ${currentPeer}`;
});

/* reject incoming call */
rejectBtn.addEventListener("click", async () => {
  if(!incomingCallId){ incomingCallEl.style.display="none"; return; }
  await db.ref("calls/" + incomingCallId).remove();
  incomingCallId = null; incomingCaller = null; incomingCallEl.style.display="none";
});

/* end call */
endCallBtn.addEventListener("click", async () => { await endCall(); });
async function endCall(){
  if(currentChatId) await db.ref("calls/" + currentChatId).remove();
  if(pc){ try{ pc.close(); } catch(e){} pc = null; }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  if(recognition){ try{ recognition.onend=null; recognition.stop(); } catch(e){} recognition=null; }
  isInCall = false; incomingCallId=null; incomingCaller=null; currentChatId=null; currentPeer=null;
  chatTitleEl.textContent = "💬 لا يوجد محادثة"; endCallBtn.classList.add("hidden");
}

/* Speech recognition while in call (caller) -> translate -> push transcripts */
function startSpeechRecognitionAndTranslate(chatId, fromLang){
  if(recognition){ try{ recognition.onend=null; recognition.stop(); } catch(e){} recognition=null; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){ alert("المتصفح لا يدعم SpeechRecognition"); return; }
  recognition = new SpeechRecognition();
  recognition.lang = fromLang;
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.onresult = async (ev) => {
    try{
      const last = ev.results[ev.results.length-1];
      const text = last[0].transcript.trim();
      if(!text) return;
      const metaSnap = await db.ref("calls/" + chatId + "/meta").once("value");
      const meta = metaSnap.val(); if(!meta) return;
      const toUser = meta.to;
      const userSnap = await db.ref("users/" + toUser).once("value");
      const receiverLang = (userSnap.val() && userSnap.val().lang) ? userSnap.val().lang : "en";
      const translated = await translateText(text, receiverLang);
      await db.ref("calls/" + chatId + "/transcripts").push({
        from: currentUser, to: toUser, original: text, translated, source: fromLang, target: receiverLang, timestamp: Date.now()
      });
      const el = document.createElement("div"); el.className="msg me";
      el.innerHTML = `<b>أنت:</b> ${escapeHtml(text)}<br><small class="muted">→ ترجمة ${receiverLang}: ${escapeHtml(translated)}</small>`;
      chatBoxEl.appendChild(el); chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
    } catch(err){ console.error("recognition onresult error:", err); }
  };
  recognition.onerror = e => console.warn("recognition error", e);
  recognition.onend = () => { if(isInCall){ try{ recognition.start(); } catch(e){} } };
  try{ recognition.start(); } catch(e){ console.error("rec start err", e); }
}

/* transcripts listener for user */
function setupTranscriptsListenerForUser(){
  db.ref("calls").on("child_added", snap => {
    const callId = snap.key;
    db.ref("calls/" + callId + "/transcripts").on("child_added", async tSnap => {
      const d = tSnap.val(); if(!d) return;
      if(d.to === currentUser){
        speakText(d.translated, d.target);
        const el = document.createElement("div"); el.className="msg other";
        el.innerHTML = `<b>🔁 ${escapeHtml(d.from)} → ${escapeHtml(d.target)}:</b> ${escapeHtml(d.translated)}`;
        chatBoxEl.appendChild(el); chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
      }
    });
  });
}

/* cleanup on call removal */
db.ref("calls").on("child_removed", snap => {
  if(snap.key === currentChatId || snap.key === incomingCallId){
    endCall();
    incomingCallEl.style.display = "none";
  }
});

/* ================= Utilities ================= */
function escapeHtml(text){ if(!text) return ""; return text.replace(/[&<>"'`=\/]/g, s=>'&#'+s.charCodeAt(0)+';'); }
function escapeJs(text){ if(!text) return ""; return text.replace(/['\\\n\r]/g, m=> (m==='\n'?'\\n':m==='\r'?'\\r': '\\'+m)); }
function sanitizeFilename(n){ return n.replace(/[^a-z0-9.\-_]/gi,'_'); }

/* expose some functions for console or quick use */
window.openChat = openChat;
window.initiateCall = initiateCall;

/* initialize some UI bits if user already logged in */
function init(){
  if(!currentUser) navLogout.classList.add("hidden");
  // load friends/requests if logged in
  if(currentUser){ loadRequests(); loadFriends(); watchIncomingCalls(); setupTranscriptsListenerForUser(); updateReqBadge(); }
}
init();

</script>
</body>
</html>
