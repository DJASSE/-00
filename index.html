<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ Ø¯Ø±Ø¯Ø´Ø© Ù…ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù„ØµÙˆØª - Ø¬Ø§Ø³Ø±</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#111; color:#fff; }
    header { background:#ff0050; padding:10px; text-align:center; font-size:20px; }
    #login, #users, #chat { display:none; padding:20px; }
    input, select, button { padding:10px; margin:5px; border:none; border-radius:5px; font-size:14px; }
    button { background:#ff0050; color:#fff; cursor:pointer; }
    button:hover { background:#e60045; }
    #chat-box { height:300px; overflow-y:auto; background:#222; padding:10px; border-radius:10px; margin:10px 0; }
    .msg { margin:6px; padding:8px; border-radius:8px; max-width:70%; }
    .me { background:#ff0050; margin-left:auto; text-align:right; }
    .other { background:#333; margin-right:auto; text-align:left; }
    #incoming-call { display:none; position:fixed; bottom:20px; right:20px; background:#222; padding:15px; border-radius:10px; box-shadow:0 0 10px #000; }
  </style>
</head>
<body>
  <header>ğŸ¤– Ø¯Ø±Ø¯Ø´Ø© Ù…ØªØ±Ø¬Ù…Ø© Ù…Ø¹ Ø§ØªØµØ§Ù„ ØµÙˆØªÙŠ</header>

  <!-- âœ… Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login" style="display:block">
    <h2>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"><br>
    <label>ğŸŒ Ø§Ø®ØªØ± Ù„ØºØªÙƒ:</label>
    <select id="lang"></select><br>
    <button onclick="login()">ğŸš€ Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- âœ… Ø´Ø§Ø´Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div id="users">
    <h2>ğŸ‘¥ Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ø¯Ø«</h2>
    <div id="user-list"></div>
  </div>

  <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="chat">
    <h2 id="chat-with">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹: </h2>
    <div id="chat-box"></div>
    <input id="msg" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    <br>
    <button onclick="startCall()">ğŸ“ Ø§ØªØµØ§Ù„ ØµÙˆØªÙŠ</button>
    <button onclick="backToUsers()">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- âœ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© -->
  <div id="incoming-call">
    <p id="caller-info">â˜ï¸ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯...</p>
    <button onclick="answerCall()">ğŸ“¥ Ø±Ø¯</button>
    <button onclick="rejectCall()">âŒ Ø±ÙØ¶</button>
  </div>

<script>
  // âœ… Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCNXyQF2ZCMaxuBplGivMZiz_rFnCt6e0M",
    authDomain: "grasias-260c5.firebaseapp.com",
    projectId: "grasias-260c5",
    storageBucket: "grasias-260c5.appspot.com",
    messagingSenderId: "673016515237",
    appId: "1:673016515237:web:ecd56c7e6b0dc81af51b4c",
    databaseURL: "https://grasias-260c5-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser=null, userLang=null, currentChatUser=null;
  let pc, localStream, remoteStream;

  // ğŸŒ ÙƒÙ„ Ø§Ù„Ù„ØºØ§Øª
  const langs = {
    "ar":"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©","en":"English","fr":"FranÃ§ais","es":"EspaÃ±ol","de":"Deutsch",
    "ru":"Ğ ÑƒÑÑĞºĞ¸Ğ¹","zh":"ä¸­æ–‡","ja":"æ—¥æœ¬èª","tr":"TÃ¼rkÃ§e","it":"Italiano",
    "pt":"PortuguÃªs","hi":"à¤¹à¤¿à¤¨à¥à¤¦à¥€","ur":"Ø§Ø±Ø¯Ùˆ","fa":"ÙØ§Ø±Ø³ÛŒ","ko":"í•œêµ­ì–´"
  };

  // â¬‡ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  window.onload=()=>{
    let sel=document.getElementById("lang");
    for(let c in langs){
      let opt=document.createElement("option");
      opt.value=c; opt.textContent=langs[c];
      sel.appendChild(opt);
    }
  };

  // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function login(){
    currentUser=document.getElementById("username").value.trim();
    userLang=document.getElementById("lang").value;
    if(!currentUser) return alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
    db.ref("users/"+currentUser).set({lang:userLang});
    document.getElementById("login").style.display="none";
    document.getElementById("users").style.display="block";
    loadUsers();
    watchIncomingCalls();
  }

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  function loadUsers(){
    db.ref("users").on("value", snap=>{
      let users=snap.val(), list="";
      for(let u in users){
        if(u!==currentUser){
          list+=`<button onclick="openChat('${u}','${users[u].lang}')">ğŸ’¬ ${u} (${langs[users[u].lang]||users[u].lang})</button>`;
        }
      }
      document.getElementById("user-list").innerHTML=list||"<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</p>";
    });
  }

  // âœ… ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø©
  function openChat(user,lang){
    currentChatUser={name:user,lang:lang};
    document.getElementById("users").style.display="none";
    document.getElementById("chat").style.display="block";
    document.getElementById("chat-with").innerText="ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹: "+user;
    document.getElementById("chat-box").innerHTML="";
    let chatId=getChatId(currentUser,user);
    db.ref("chats/"+chatId+"/messages").off();
    db.ref("chats/"+chatId+"/messages").on("child_added", async snap=>{
      let d=snap.val(); let msg=d.text;
      if(d.lang!==userLang) msg=await translateText(d.text,userLang);
      let div=document.createElement("div");
      div.className="msg "+(d.sender===currentUser?"me":"other");
      div.innerHTML=`<b>${d.sender}:</b> ${msg}`;
      document.getElementById("chat-box").appendChild(div);
      document.getElementById("chat-box").scrollTop=document.getElementById("chat-box").scrollHeight;
    });
  }

  function getChatId(u1,u2){ return [u1,u2].sort().join("_"); }

  // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  function sendMessage(){
    let text=document.getElementById("msg").value.trim();
    if(!text) return;
    let chatId=getChatId(currentUser,currentChatUser.name);
    db.ref("chats/"+chatId+"/messages").push({
      sender:currentUser,text:text,lang:userLang,timestamp:Date.now()
    });
    document.getElementById("msg").value="";
  }

  async function translateText(text,target){
    const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(text)}`;
    const res=await fetch(url); const data=await res.json();
    return data[0][0][0];
  }

  function backToUsers(){
    document.getElementById("chat").style.display="none";
    document.getElementById("users").style.display="block";
  }

  // âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµÙˆØªÙŠ
  async function startCall(){
    await initPeer();
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    let callId=getChatId(currentUser,currentChatUser.name);
    db.ref("calls/"+callId+"/offer").set(JSON.stringify(offer));

    db.ref("calls/"+callId+"/answer").on("value",async snap=>{
      if(snap.val()){
        const answer=JSON.parse(snap.val());
        await pc.setRemoteDescription(answer);
      }
    });

    db.ref("calls/"+callId+"/candidates").on("child_added",async snap=>{
      let cand=JSON.parse(snap.val());
      try{ await pc.addIceCandidate(new RTCIceCandidate(cand)); }catch(e){}
    });

    startVoiceTranslate(userLang,currentChatUser.lang);
  }

  // âœ… ØªÙ‡ÙŠØ¦Ø© WebRTC
  async function initPeer(){
    pc=new RTCPeerConnection();
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.onicecandidate=e=>{
      if(e.candidate){
        db.ref("calls/"+getChatId(currentUser,currentChatUser.name)+"/candidates").push(JSON.stringify(e.candidate));
      }
    };
  }

  // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
  function watchIncomingCalls(){
    db.ref("calls").on("child_added",snap=>{
      let callId=snap.key;
      if(callId.includes(currentUser)){
        db.ref("calls/"+callId+"/offer").once("value",offerSnap=>{
          if(offerSnap.val()){
            let caller=callId.replace(currentUser,"").replace("_","");
            document.getElementById("caller-info").innerText="â˜ï¸ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯ Ù…Ù†: "+caller;
            document.getElementById("incoming-call").style.display="block";
            currentChatUser={name:caller,lang:"en"}; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
          }
        });
      }
    });
  }

  // âœ… Ø§Ù„Ø±Ø¯
  async function answerCall(){
    document.getElementById("incoming-call").style.display="none";
    await initPeer();
    let callId=getChatId(currentUser,currentChatUser.name);
    let offerSnap=await db.ref("calls/"+callId+"/offer").once("value");
    const offer=JSON.parse(offerSnap.val());
    await pc.setRemoteDescription(offer);
    const answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    db.ref("calls/"+callId+"/answer").set(JSON.stringify(answer));
    db.ref("calls/"+callId+"/candidates").on("child_added",async snap=>{
      let cand=JSON.parse(snap.val());
      try{ await pc.addIceCandidate(new RTCIceCandidate(cand)); }catch(e){}
    });
    startVoiceTranslate(userLang,currentChatUser.lang);
  }

  // âœ… Ø±ÙØ¶
  function rejectCall(){
    document.getElementById("incoming-call").style.display="none";
    db.ref("calls/"+getChatId(currentUser,currentChatUser.name)).remove();
  }

  // âœ… Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„ØµÙˆØªÙŠØ©
  function startVoiceTranslate(fromLang,toLang){
    const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
    recognition.lang=fromLang;
    recognition.continuous=true;
    recognition.onresult=async e=>{
      const text=e.results[e.results.length-1][0].transcript;
      const translated=await translateText(text,toLang);
      speak(translated,toLang);
    };
    recognition.start();
  }

  function speak(text,lang){
    let u=new SpeechSynthesisUtterance(text);
    u.lang=lang;
    speechSynthesis.speak(u);
  }
</script>
</body>
</html>
