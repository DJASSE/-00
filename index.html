<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Ø¯Ø±Ø¯Ø´Ø© Ù…ØªØ±Ø¬Ù…Ø© + Ø§ØªØµØ§Ù„ ØµÙˆØªÙŠ ÙÙˆØ±ÙŠ</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1724; --accent:#00d1b2; --accent2:#3b82f6; --muted:#9aa6bf;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma,Arial;background:linear-gradient(135deg,var(--bg),#051029);color:#fff;padding:18px}
    .wrap{max-width:1000px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    h2{margin:0 0 10px 0;color:var(--accent)}
    label{display:block;margin-top:8px;color:var(--muted);font-size:13px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:none;font-size:14px}
    button{cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000;font-weight:700}
    button.gray{background:#333;color:#fff}
    .users-list button{display:flex;justify-content:space-between;gap:8px;margin:8px 0;padding:8px;align-items:center}
    #chat-box{height:60vh;overflow:auto;padding:12px;background:rgba(0,0,0,0.25);border-radius:8px}
    .msg{margin:8px 0;padding:10px;border-radius:12px;max-width:75%;word-break:break-word}
    .me{background:linear-gradient(90deg,var(--accent),#00f6d0);color:#000;margin-left:auto;text-align:right}
    .other{background:#1b2638;color:#fff;margin-right:auto;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px}
    .small{padding:8px;font-size:13px}
    .incoming-call{position:fixed;right:22px;bottom:22px;background:#111;padding:14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none;z-index:999}
    img,video{max-width:260px;border-radius:8px;margin-top:6px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT: ØªØ³Ø¬ÙŠÙ„ + Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ØºØ§Øª + Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† -->
    <div class="card">
      <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ / Ù„ØºØªÙŠ</h2>
      <label>Ø§Ø³Ù…Ùƒ</label>
      <input id="username" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ...">
      <label>Ø¨Ø­Ø« Ù„ØºØ©</label>
      <input id="langSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù„ØºØ©...">
      <label>Ø§Ø®ØªØ± Ù„ØºØ© Ø§Ù„ØªØ­Ø¯Ø« (Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙØ­Ø³Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ©)</label>
      <select id="langSelect" size="6" style="height:150px"></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        <button id="logoutBtn" class="gray" style="display:none">Ø®Ø±ÙˆØ¬</button>
      </div>

      <hr style="opacity:0.06;margin:12px 0">
      <h2>ğŸ‘¥ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h2>
      <div class="muted">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¯Ø±Ø¯Ø´Ø©" Ù„ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ùˆ "ğŸ“" Ù„Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© ÙÙˆØ±ÙŠØ©</div>
      <div id="userList" class="users-list" style="margin-top:10px"></div>
    </div>

    <!-- RIGHT: Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© + Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="chatTitle">ğŸ’¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
          <div id="chatSubtitle" class="muted">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„Ø¨Ø¯Ø¡</div>
        </div>
        <div>
          <button id="endCallBtn" class="gray small" style="display:none">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
        </div>
      </div>

      <div id="chat-box"></div>

      <div style="margin-top:10px;display:flex;gap:8px;">
        <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
        <button id="sendBtn" class="small">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button id="sendFileBtn" class="small">Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù</button>
        <div style="flex:1"></div>
        <div class="muted">Ù„ØºØªÙŠ: <span id="currentLangLabel">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span></div>
      </div>

      <hr style="opacity:0.06;margin:12px 0">
      <h2>ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø§Øª ØµÙˆØªÙŠØ© Ù…ØªØ±Ø¬Ù…Ø©</h2>
      <div class="muted">Ù…ÙŠØ²Ø§Øª: ØªØ­ÙˆÙŠÙ„ ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø±Ø³Ù„ â†’ Ù†Øµ â†’ ØªØ±Ø¬Ù…Ø© â†’ Ù†Ø·Ù‚ Ø¨Ù„ØºØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…. Ø§Ø³ØªØ®Ø¯Ù… Chrome/Edge Ù„ØªØ¬Ø±Ø¨Ø© Ø£ÙØ¶Ù„.</div>
    </div>
  </div>

  <!-- Ø¥Ø´Ø¹Ø§Ø± Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯ -->
  <div id="incomingCall" class="incoming-call">
    <div id="callerTxt" style="margin-bottom:8px">ğŸ“ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯</div>
    <div style="display:flex;gap:8px">
      <button id="answerBtn">ğŸ“¥ Ø±Ø¯</button>
      <button id="rejectBtn" class="gray">âŒ Ø±ÙØ¶</button>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCNXyQF2ZCMaxuBplGivMZiz_rFnCt6e0M",
  authDomain: "grasias-260c5.firebaseapp.com",
  projectId: "grasias-260c5",
  storageBucket: "grasias-260c5.appspot.com",
  messagingSenderId: "673016515237",
  appId: "1:673016515237:web:ecd56c7e6b0dc81af51b4c",
  databaseURL: "https://grasias-260c5-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ============== State ============== */
let currentUser = null;
let userLang = "ar";
let currentPeer = null;       // Ø§Ø³Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø°ÙŠ ØªØªØ­Ø¯Ø«/ØªØªØµÙ„ Ø¨Ù‡
let currentChatId = null;
let pc = null;
let localStream = null;
let recognition = null;
let isInCall = false;
let incomingCallId = null;    // chatId Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
let incomingCaller = null;    // Ø§Ø³Ù… Ø§Ù„Ù…ØªØµÙ„

/* ============== Languages list (code + name) ============== */
const langs = [
  {code:"af",name:"Afrikaans"},{code:"ar",name:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"},{code:"az",name:"AzÉ™rbaycan"},{code:"be",name:"Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑĞºĞ°Ñ"},
  {code:"bg",name:"Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸"},{code:"bn",name:"à¦¬à¦¾à¦‚à¦²à¦¾"},{code:"bs",name:"Bosanski"},{code:"ca",name:"CatalÃ "},{code:"ceb",name:"Cebuano"},
  {code:"cs",name:"ÄŒeÅ¡tina"},{code:"cy",name:"Cymraeg"},{code:"da",name:"Dansk"},{code:"de",name:"Deutsch"},{code:"el",name:"Î•Î»Î»Î·Î½Î¹ÎºÎ¬"},
  {code:"en",name:"English"},{code:"eo",name:"Esperanto"},{code:"es",name:"EspaÃ±ol"},{code:"et",name:"Eesti"},{code:"eu",name:"Euskara"},
  {code:"fa",name:"ÙØ§Ø±Ø³ÛŒ"},{code:"fi",name:"Suomi"},{code:"fil",name:"Filipino"},{code:"fr",name:"FranÃ§ais"},{code:"fy",name:"Frysk"},
  {code:"ga",name:"Gaeilge"},{code:"gd",name:"GÃ idhlig"},{code:"gl",name:"Galego"},{code:"gu",name:"àª—à«àªœàª°àª¾àª¤à«€"},{code:"ha",name:"Hausa"},
  {code:"haw",name:"Ê»ÅŒlelo HawaiÊ»i"},{code:"he",name:"×¢×‘×¨×™×ª"},{code:"hi",name:"à¤¹à¤¿à¤¨à¥à¤¦à¥€"},{code:"hmn",name:"Hmong"},{code:"hr",name:"Hrvatski"},
  {code:"ht",name:"KreyÃ²l ayisyen"},{code:"hu",name:"Magyar"},{code:"hy",name:"Õ€Õ¡ÕµÕ¥Ö€Õ¥Õ¶"},{code:"id",name:"Bahasa Indonesia"},{code:"ig",name:"Igbo"},
  {code:"is",name:"Ãslenska"},{code:"it",name:"Italiano"},{code:"ja",name:"æ—¥æœ¬èª"},{code:"jv",name:"Basa Jawa"},{code:"ka",name:"áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜"},
  {code:"kk",name:"ÒšĞ°Ğ·Ğ°Ò›ÑˆĞ°"},{code:"km",name:"ááŸ’á˜áŸ‚áš"},{code:"kn",name:"à²•à²¨à³à²¨à²¡"},{code:"ko",name:"í•œêµ­ì–´"},{code:"ku",name:"KurdÃ®"},
  {code:"ky",name:"ĞšÑ‹Ñ€Ğ³Ñ‹Ğ·Ñ‡Ğ°"},{code:"la",name:"Latina"},{code:"lb",name:"LÃ«tzebuergesch"},{code:"lo",name:"àº¥àº²àº§"},{code:"lt",name:"LietuviÅ³"},
  {code:"lv",name:"LatvieÅ¡u"},{code:"mg",name:"Malagasy"},{code:"mi",name:"MÄori"},{code:"mk",name:"ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸"},{code:"ml",name:"à´®à´²à´¯à´¾à´³à´‚"},
  {code:"mn",name:"ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»"},{code:"mr",name:"à¤®à¤°à¤¾à¤ à¥€"},{code:"ms",name:"Bahasa Melayu"},{code:"mt",name:"Malti"},{code:"my",name:"á€™á€¼á€”á€ºá€™á€¬"},
  {code:"ne",name:"à¤¨à¥‡à¤ªà¤¾à¤²à¥€"},{code:"nl",name:"Nederlands"},{code:"no",name:"Norsk"},{code:"ny",name:"Chichewa"},{code:"pa",name:"à¨ªà©°à¨œà¨¾à¨¬à©€"},
  {code:"pl",name:"Polski"},{code:"ps",name:"Ù¾ÚšØªÙˆ"},{code:"pt",name:"PortuguÃªs"},{code:"ro",name:"RomÃ¢nÄƒ"},{code:"ru",name:"Ğ ÑƒÑÑĞºĞ¸Ğ¹"},
  {code:"rw",name:"Kinyarwanda"},{code:"sd",name:"Ø³Ù†ÚŒÙŠ"},{code:"si",name:"à·ƒà·’à¶‚à·„à¶½"},{code:"sk",name:"SlovenÄina"},{code:"sl",name:"SlovenÅ¡Äina"},
  {code:"sm",name:"Gagana Samoa"},{code:"sn",name:"Shona"},{code:"so",name:"Soomaali"},{code:"sq",name:"Shqip"},{code:"sr",name:"Ğ¡Ñ€Ğ¿ÑĞºĞ¸"},
  {code:"st",name:"Sesotho"},{code:"su",name:"Basa Sunda"},{code:"sv",name:"Svenska"},{code:"sw",name:"Kiswahili"},{code:"ta",name:"à®¤à®®à®¿à®´à¯"},
  {code:"te",name:"à°¤à±†à°²à±à°—à±"},{code:"tg",name:"Ğ¢Ğ¾Ò·Ğ¸ĞºÓ£"},{code:"th",name:"à¹„à¸—à¸¢"},{code:"tk",name:"TÃ¼rkmenÃ§e"},{code:"tl",name:"Tagalog"},
  {code:"tr",name:"TÃ¼rkÃ§e"},{code:"tt",name:"Ğ¢Ğ°Ñ‚Ğ°Ñ€Ñ‡Ğ°"},{code:"ug",name:"Ø¦Û‡ÙŠØºÛ‡Ø±Ú†Û•"},{code:"uk",name:"Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°"},{code:"ur",name:"Ø§Ø±Ø¯Ùˆ"},
  {code:"uz",name:"OÊ»zbekcha"},{code:"vi",name:"Tiáº¿ng Viá»‡t"},{code:"xh",name:"isiXhosa"},{code:"yi",name:"×™×™Ö´×“×™×©"},{code:"yo",name:"YorÃ¹bÃ¡"},
  {code:"zh",name:"ä¸­æ–‡"},{code:"zu",name:"isiZulu"}
];

/* ============== DOM ============== */
const usernameEl = document.getElementById("username");
const langSearchEl = document.getElementById("langSearch");
const langSelectEl = document.getElementById("langSelect");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userListEl = document.getElementById("userList");
const chatBoxEl = document.getElementById("chat-box");
const chatTitleEl = document.getElementById("chatTitle");
const chatSubtitleEl = document.getElementById("chatSubtitle");
const msgInputEl = document.getElementById("msgInput");
const sendBtnEl = document.getElementById("sendBtn");
const fileInputEl = document.getElementById("fileInput");
const sendFileBtnEl = document.getElementById("sendFileBtn");
const currentLangLabel = document.getElementById("currentLangLabel");
const endCallBtn = document.getElementById("endCallBtn");

const incomingCallEl = document.getElementById("incomingCall");
const callerTxtEl = document.getElementById("callerTxt");
const answerBtn = document.getElementById("answerBtn");
const rejectBtn = document.getElementById("rejectBtn");

/* ============== Render languages + search ============== */
function renderLangs(filter=""){
  langSelectEl.innerHTML = "";
  langs.filter(l => l.name.toLowerCase().includes(filter.toLowerCase()))
    .forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.code; opt.textContent = l.name;
      langSelectEl.appendChild(opt);
    });
  if(!langSelectEl.value) langSelectEl.value = "ar";
  userLang = langSelectEl.value;
  currentLangLabel.innerText = langs.find(x=>x.code===userLang)?.name || userLang;
}
langSearchEl.addEventListener("input", e => renderLangs(e.target.value));
langSelectEl.addEventListener("change", e => {
  userLang = e.target.value;
  currentLangLabel.innerText = langs.find(x=>x.code===userLang)?.name || userLang;
});
renderLangs();

/* ============== Login / Logout ============== */
loginBtn.addEventListener("click", async () => {
  const name = usernameEl.value.trim();
  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
  currentUser = name;
  // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ù„ØºØªÙ‡
  await db.ref("users/" + currentUser).set({ lang: userLang, online: true });
  localStorage.setItem("chat_user", currentUser);
  usernameEl.disabled = true;
  loginBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";
  loadUsers();
  watchIncomingCalls(); // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
});

logoutBtn.addEventListener("click", async () => {
  if(!currentUser) return;
  await db.ref("users/" + currentUser).remove();
  localStorage.removeItem("chat_user");
  currentUser = null;
  usernameEl.disabled = false;
  loginBtn.style.display = "inline-block";
  logoutBtn.style.display = "none";
  userListEl.innerHTML = "";
  chatBoxEl.innerHTML = "";
  chatTitleEl.textContent = "ğŸ’¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø©";
  chatSubtitleEl.textContent = "Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„Ø¨Ø¯Ø¡";
});

/* Restore user */
window.addEventListener("load", () => {
  const saved = localStorage.getItem("chat_user");
  if(saved){
    usernameEl.value = saved;
    loginBtn.click();
  }
});

/* ============== Load users list ============== */
function loadUsers(){
  db.ref("users").on("value", snap => {
    const users = snap.val() || {};
    userListEl.innerHTML = "";
    for(const name in users){
      if(name === currentUser) continue;
      const row = document.createElement("div");
      row.style.display = "flex"; row.style.gap = "8px"; row.style.alignItems = "center"; row.style.marginBottom = "8px";
      const label = document.createElement("div"); label.textContent = name; label.style.flex = "1";
      const chatBtn = document.createElement("button"); chatBtn.textContent = "Ø¯Ø±Ø¯Ø´Ø©"; chatBtn.className = "small";
      chatBtn.onclick = () => openChat(name);
      const callBtn = document.createElement("button"); callBtn.textContent = "ğŸ“ Ø§ØªØµØ§Ù„"; callBtn.className = "small";
      callBtn.onclick = () => initiateCall(name);
      row.appendChild(label); row.appendChild(chatBtn); row.appendChild(callBtn);
      userListEl.appendChild(row);
    }
    if(Object.keys(users).length <= (currentUser?1:0)) {
      userListEl.innerHTML = "<div class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>";
    }
  });
}

/* ============== Chat text messaging ============== */
function getChatId(a,b){ return [a,b].sort().join("_"); }

function openChat(peer){
  currentPeer = peer;
  currentChatId = getChatId(currentUser, peer);
  chatTitleEl.textContent = "ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹: " + peer;
  chatSubtitleEl.textContent = "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: " + (langs.find(x=>x.code===userLang)?.name || userLang);
  chatBoxEl.innerHTML = "";
  // Listen for messages
  db.ref("chats/" + currentChatId + "/messages").off();
  db.ref("chats/" + currentChatId + "/messages").on("child_added", snap => {
    const data = snap.val();
    renderMessage(data);
  });
}

function renderMessage(data){
  const el = document.createElement("div");
  el.className = "msg " + (data.sender === currentUser ? "me" : "other");
  let content = "";
  if(data.type === "media"){
    if(data.mediaType && data.mediaType.startsWith("image")){
      content = `<b>${data.sender}:</b><br><img src="${data.text}" alt="image">`;
    } else {
      content = `<b>${data.sender}:</b><br><video src="${data.text}" controls></video>`;
    }
  } else {
    content = `<b>${data.sender}:</b> ${data.text}`;
  }
  el.innerHTML = content;
  chatBoxEl.appendChild(el);
  chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
}

sendBtnEl.addEventListener("click", async () => {
  if(!currentPeer) return alert("Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
  const text = msgInputEl.value.trim();
  if(!text) return;
  const id = getChatId(currentUser, currentPeer);
  await db.ref("chats/" + id + "/messages").push({
    sender: currentUser, text, lang: userLang, type: "text", timestamp: Date.now()
  });
  msgInputEl.value = "";
});

sendFileBtnEl.addEventListener("click", async () => {
  if(!currentPeer) return alert("Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
  const f = fileInputEl.files[0];
  if(!f) return alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹");
  // Ø±ÙØ¹ Ø¥Ù„Ù‰ Firebase Storage Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·
  const storageRef = storage.ref("chatFiles/" + Date.now() + "_" + f.name);
  await storageRef.put(f);
  const url = await storageRef.getDownloadURL();
  const id = getChatId(currentUser, currentPeer);
  await db.ref("chats/" + id + "/messages").push({
    sender: currentUser, text: url, lang: userLang, type: "media", mediaType: f.type, timestamp: Date.now()
  });
  fileInputEl.value = "";
});

/* ============== Translation (gtx free endpoint) ============== */
async function translateText(text, target){
  try{
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${encodeURIComponent(target)}&dt=t&q=${encodeURIComponent(text)}`;
    const res = await fetch(url);
    const data = await res.json();
    return (data && data[0] && data[0][0] && data[0][0][0]) ? data[0][0][0] : text;
  } catch(err){
    console.error("translate error", err);
    return text;
  }
}

/* ============== CALLING: initiate / answer / reject / signaling ============== */

/* initiate call to peer */
async function initiateCall(peerName){
  if(!currentUser) return alert("Ø³Ø¬Ù‘Ù„ Ø£ÙˆÙ„Ø§Ù‹");
  if(!peerName) return;
  currentPeer = peerName;
  const chatId = getChatId(currentUser, peerName);
  currentChatId = chatId;

  // meta with from/to and callerLang
  await db.ref("calls/" + chatId + "/meta").set({
    from: currentUser,
    to: peerName,
    callerLang: userLang,
    timestamp: Date.now()
  });

  // create peer connection & offer
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});

  // get mic
  try{
    localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
  } catch(err){
    return alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + err.message);
  }
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  // ice -> push to DB
  const candRef = db.ref("calls/" + chatId + "/candidates");
  pc.onicecandidate = e => { if(e.candidate) candRef.push(JSON.stringify(e.candidate)); };

  // remote audio (play)
  pc.ontrack = ev => {
    const audio = document.createElement("audio");
    audio.autoplay = true;
    audio.srcObject = ev.streams[0];
    audio.style.display = "none";
    document.body.appendChild(audio);
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await db.ref("calls/" + chatId + "/offer").set(JSON.stringify(offer));

  // listen for answer
  db.ref("calls/" + chatId + "/answer").on("value", async snap => {
    const val = snap.val();
    if(val && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(val));
      // start speech recognition & translate after remote set
      startSpeechRecognitionAndTranslate(chatId, userLang);
      isInCall = true;
      endCallBtn.style.display = "inline-block";
      chatTitleEl.textContent = `ğŸ“ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø¹ ${peerName}`;
    }
  });

  // listen for remote ICE
  db.ref("calls/" + chatId + "/candidates").on("child_added", async snap => {
    const v = snap.val();
    if(v && pc) {
      try { await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(v))); } catch(e){}
    }
  });

  // listener for transcripts so caller can see
  db.ref("calls/" + chatId + "/transcripts").on("child_added", snap => {
    const d = snap.val();
    if(!d) return;
    // render transcript
    const el = document.createElement("div");
    el.className = "msg me";
    el.innerHTML = `<b>ğŸ” ØªØ±Ø¬Ù…Ø© (${d.source}â†’${d.target}):</b> ${d.translated}`;
    chatBoxEl.appendChild(el);
    chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
  });
}

/* watch incoming calls globally for currentUser */
function watchIncomingCalls(){
  db.ref("calls").on("child_added", async snap => {
    const chatId = snap.key;
    const val = snap.val();
    if(!val || !val.meta) return;
    const meta = val.meta;
    // if this call is addressed to me and not already in progress
    if(meta.to === currentUser && !isInCall){
      incomingCallId = chatId;
      incomingCaller = meta.from;
      callerTxtEl.textContent = `ğŸ“ Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯ Ù…Ù†: ${incomingCaller}`;
      incomingCallEl.style.display = "block";
    }
  });
}

/* answer incoming call */
answerBtn.addEventListener("click", async () => {
  if(!incomingCallId) return;
  incomingCallEl.style.display = "none";
  // set currentPeer from meta
  const metaSnap = await db.ref("calls/" + incomingCallId + "/meta").once("value");
  const meta = metaSnap.val();
  if(!meta) return alert("Ù…Ø´ÙƒÙ„Ø©: Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©");
  currentPeer = meta.from;
  currentChatId = incomingCallId;

  // create pc and get mic
  pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  try{
    localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:false});
  } catch(err){ return alert("ÙØ´Ù„ Ø¨Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§ÙŠÙƒ: " + err.message); }
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  // remote audio
  pc.ontrack = ev => {
    const audio = document.createElement("audio");
    audio.autoplay = true;
    audio.srcObject = ev.streams[0];
    audio.style.display = "none";
    document.body.appendChild(audio);
  };

  // ICE
  const candRef = db.ref("calls/" + incomingCallId + "/candidates");
  pc.onicecandidate = e => { if(e.candidate) candRef.push(JSON.stringify(e.candidate)); };

  // get offer
  const offerSnap = await db.ref("calls/" + incomingCallId + "/offer").once("value");
  const offer = offerSnap.val();
  if(!offer) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±Ø¶ Ù„Ù„ØµÙˆØª (offer).");
  await pc.setRemoteDescription(JSON.parse(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await db.ref("calls/" + incomingCallId + "/answer").set(JSON.stringify(answer));

  // listen ICE
  db.ref("calls/" + incomingCallId + "/candidates").on("child_added", async snap => {
    const v = snap.val();
    if(v && pc) {
      try { await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(v))); } catch(e){}
    }
  });

  // listen transcripts â€” when someone pushes transcript targeted to me, speak it
  db.ref("calls/" + incomingCallId + "/transcripts").on("child_added", async snap => {
    const d = snap.val();
    if(!d) return;
    // if this transcript is targeted at me (d.to === currentUser), speak it
    if(d.to === currentUser){
      speakText(d.translated, d.target);
      // also show in chat area
      const el = document.createElement("div");
      el.className = "msg other";
      el.innerHTML = `<b>ğŸ” (${d.from}â†’${d.target}):</b> ${d.translated}`;
      chatBoxEl.appendChild(el);
      chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
    }
  });

  // fetch receiver's language (my language) from users node to know my language label in meta if needed
  isInCall = true;
  endCallBtn.style.display = "inline-block";
  chatTitleEl.textContent = `ğŸ“ ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø¹ ${currentPeer}`;
  // after answer, start listening for transcription pushes (the caller will push transcripts)
});

/* reject incoming call */
rejectBtn.addEventListener("click", async () => {
  if(!incomingCallId) { incomingCallEl.style.display = "none"; return; }
  // remove call node
  await db.ref("calls/" + incomingCallId).remove();
  incomingCallId = null; incomingCaller = null;
  incomingCallEl.style.display = "none";
});

/* end call cleanup */
endCallBtn.addEventListener("click", async () => { await endCall(); });

async function endCall(){
  if(currentChatId) {
    // remove call node (optional)
    await db.ref("calls/" + currentChatId).remove();
  }
  if(pc){ try{ pc.close(); } catch(e){} pc = null; }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  if(recognition){ try{ recognition.onend = null; recognition.stop(); } catch(e){} recognition = null; }
  isInCall = false;
  incomingCallId = null; incomingCaller = null; currentChatId = null;
  currentPeer = null;
  chatTitleEl.textContent = "ğŸ’¬ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø©";
  endCallBtn.style.display = "none";
}

/* ============== Speech recognition (caller) -> translate -> push transcript ============== */
function startSpeechRecognitionAndTranslate(chatId, fromLang){
  // stop previous if any
  if(recognition){ try{ recognition.onend = null; recognition.stop(); } catch(e){} recognition = null; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Speech API (SpeechRecognition). Ø§Ø³ØªØ®Ø¯Ù… Chrome/Edge Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©.");
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = fromLang;
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = async (ev) => {
    try{
      const last = ev.results[ev.results.length-1];
      const text = last[0].transcript.trim();
      if(!text) return;
      // read meta to know to whom
      const metaSnap = await db.ref("calls/" + chatId + "/meta").once("value");
      const meta = metaSnap.val();
      if(!meta) return;
      const toUser = meta.to;
      // get receiver language
      const userSnap = await db.ref("users/" + toUser).once("value");
      const receiverLang = (userSnap.val() && userSnap.val().lang) ? userSnap.val().lang : "en";

      // translate text (gtx)
      const translated = await translateText(text, receiverLang);

      // push transcript object to DB
      await db.ref("calls/" + chatId + "/transcripts").push({
        from: currentUser,
        to: toUser,
        original: text,
        translated: translated,
        source: fromLang,
        target: receiverLang,
        timestamp: Date.now()
      });

      // show on caller's chat box
      const el = document.createElement("div");
      el.className = "msg me";
      el.innerHTML = `<b>Ø£Ù†Øª:</b> ${text}<br><small class="muted">â†’ ØªØ±Ø¬Ù…Ø© ${receiverLang}: ${translated}</small>`;
      chatBoxEl.appendChild(el);
      chatBoxEl.scrollTop = chatBoxEl.scrollHeight;

    } catch(err){
      console.error("recognition onresult error:", err);
    }
  };

  recognition.onerror = e => console.warn("recognition error", e);
  recognition.onend = () => { if(isInCall){ try{ recognition.start(); } catch(e){} } };
  try{ recognition.start(); } catch(e){ console.error("rec start err", e); }
}

/* translate helper (gtx) */
async function translateText(text, target){
  try{
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${encodeURIComponent(target)}&dt=t&q=${encodeURIComponent(text)}`;
    const res = await fetch(url);
    const data = await res.json();
    return (data && data[0] && data[0][0] && data[0][0][0]) ? data[0][0][0] : text;
  } catch(err){
    console.error("translate error", err);
    return text;
  }
}

/* speech synthesis (speak) */
function speakText(text, lang){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = 1;
    u.pitch = 1;
    window.speechSynthesis.speak(u);
  } catch(err){
    console.error("speak error", err);
  }
}

/* ============== Incoming transcripts listener for current user (speak when d.to === currentUser) ============== */
function setupTranscriptsListenerForUser(){
  // Listen to all calls nodes and speak anything targeted to me
  db.ref("calls").on("child_added", snap => {
    const callId = snap.key;
    // listen transcripts of this call
    db.ref("calls/" + callId + "/transcripts").on("child_added", async tSnap => {
      const d = tSnap.val();
      if(!d) return;
      if(d.to === currentUser){
        // natively speak
        speakText(d.translated, d.target);
        // add to chat box if we are in chat with the sender
        const el = document.createElement("div");
        el.className = "msg other";
        el.innerHTML = `<b>ğŸ” ${d.from} â†’ ${d.target}:</b> ${d.translated}`;
        chatBoxEl.appendChild(el);
        chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
      }
    });
  });
}

/* init transcripts listener */
setupTranscriptsListenerForUser();

/* ============== watch for call removal (cleanup) ============== */
db.ref("calls").on("child_removed", snap => {
  if(snap.key === currentChatId || snap.key === incomingCallId){
    // if call removed, cleanup
    endCall();
    incomingCallEl.style.display = "none";
  }
});

/* ============== Utility: when clicking a user in list we open chat ============== */
function openChat(name){
  openChatInternal(name);
}
function openChatInternal(name){
  openChat(name);
}

/* (openChat function defined earlier) - keep compatibility */

/* ============== End of script ============== */
</script>
</body>
</html>
